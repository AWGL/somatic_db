{% extends 'analysis/base.html' %}
{% load crispy_forms_tags %}

{% block breadcrumbs %}
<div class="container-fluid breadcrumbs-custom">
  <div class="container">
    <ol class="breadcrumb" style="background-color: transparent;">
      <li class="breadcrumb-item"><a href="{% url 'home_swgs' %}"><span class="fa fa-home"></span></a></li>
      <li class="breadcrumb-item"><a href="{% url 'view_patient_analysis'}"></a> Patient Analysis</li>
      <li class="breadcrumb-item"> !REPLACE with Patient Identifier </li>
    </ol>
  </div>
</div>
{% endblock %}

{% block content %}

<div class="container">
  <h3>Variants for tumour sample {{ patient_analysis.tumour_sample.sample_id }} and germline sample {{ patient_analysis.germline_sample.sample_id }}</h3>
  <h5>Variants have been filtered in the following way:</h5>
  <ul>
    <li>Variants with a VAF of >5% in GnomAD have been removed</li>
    <li>Variants are excluded if their most severe consequence is a MODIFIER strength - see <a href="https://www.ensembl.org/info/genome/variation/prediction/predicted_data.html", target="_blank">VEP Documentation</a></li>
    <li>Variants flagged as "Possible MNV - Check IGV" have been included irrespective of gnomAD VAF as the MNV may have different consequences than the multiple SNVs</li>
  </ul>
  <br>
  <h5>Download SNVs for this patient in a CSV:</h5>
  {% crispy form %}
  <br>
  <br>
  <div class="float-right">
    <button type="button" class="btn btn-success snv-submit" id = "snv-submit">Submit Checks</button>
  </div>
  <br>
  <br>
  <h4>Somatic SNVs</h4>
  <h5>Tier 1</h5>
  <table class="table">
    <thead>
      <tr>
        <th class="col-md-4">Variant</th>
        <th class="col-md-4">HGVSc / HGVSp</th>
        <th class="col-md-1">Gene</th>
        <th class="col-md-1">VAF</th>
        <th class="col-md-2">GnomAD</th>
        <th class="col-md-4">Checks</th>
        <th class="col-md-2">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for v in somatic_snvs_tier_one %}
      <tr>
        <td class="variant-id" style="display:none">{{ v.id }}</td>
        <td class="var-type" style="display:none">{{ v.var_type }}</td>
        {% if v.force_display %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</br><span class="badge badge-warning badge-pill">Possible MNV - Check IGV</span></td>
        {% else %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</td>
        {% endif %}
        <td>{{ v.hgvsc }}</br>{{ v.hgvsp }}</td>
        <td>{{ v.gene }}</td>
        <td>{{ v.vaf }}%</td>
        <td>{{ v.gnomad }}</td>
        
        {% if v.checks|length > 0 %}
        <td>
        {% for check in v.checks %}
        {{ forloop.counter }}: {{ check.decision }} {{ check.user }}
        {% endfor %}
        </td>
        {% else %}
        <td>1: Pending</td>
        {% endif %}
        
        {% if v.status == 'Complete' %}
        <td>{{ v.status }}</td>
        {% else %}
        <td class=genuine-dropdown>
          <select name = "variant" id="variant">
            {% for option in check_options %}
            <option value="{{ option.0 }}">{{ option.1 }}</option>
            {% endfor %}
          </select>
        </td>
        {% endif %}

      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br>
  <h5>Tier 2</h5>
  <table class="table">
    <thead>
      <tr>
        <th class="col-md-4">Variant</th>
        <th class="col-md-4">HGVSc / HGVSp</th>
        <th class="col-md-1">Gene</th>
        <th class="col-md-1">VAF</th>
        <th class="col-md-2">GnomAD</th>
        <th class="col-md-4">Checks</th>
        <th class="col-md-2">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for v in somatic_snvs_tier_two %}
      <tr>
        <td class="variant-id" style="display:none">{{ v.id }}</td>
        <td class="var-type" style="display:none">{{ v.var_type }}</td>
        {% if v.force_display %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</br><span class="badge badge-warning badge-pill">Possible MNV - Check IGV</span></td>
        {% else %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</td>
        {% endif %}
        <td>{{ v.hgvsc }}</br>{{ v.hgvsp }}</td>
        <td>{{ v.gene }}</td>
        <td>{{ v.vaf }}%</td>
        <td>{{ v.gnomad }}</td>

        {% if v.checks|length > 0 %}
        <td>
        {% for check in v.checks %}
        {{ forloop.counter }}: {{ check.decision }} {{ check.user }}
        {% endfor %}
        </td>
        {% else %}
        <td>1: Pending</td>
        {% endif %}

        {% if v.status == 'Complete' %}
        <td>{{ v.status }}</td>
        {% else %}
        <td class=genuine-dropdown>
          <select name = "variant" id="variant">
            {% for option in check_options %}
            <option value="{{ option.0 }}">{{ option.1 }}</option>
            {% endfor %}
          </select>
        </td>
        {% endif %}

      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br>
  <br>
  <h4>Germline SNVs</h4>
  <h5>Tier 1</h5>
  <table class="table">
    <thead>
      <tr>
        <th class="col-md-4">Variant</th>
        <th class="col-md-4">HGVSc / HGVSp</th>
        <th class="col-md-1">Gene</th>
        <th class="col-md-1">VAF</th>
        <th class="col-md-2">GnomAD</th>
        <th class="col-md-4">Checks</th>
        <th class="col-md-2">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for v in germline_snvs_tier_one %}
      <tr>
        <td class="variant-id" style="display:none">{{ v.id }}</td>
        <td class="var-type" style="display:none">{{ v.var_type }}</td>
        {% if v.force_display %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</br><span class="badge badge-warning badge-pill">Possible MNV - Check IGV</span></td>
        {% else %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</td>
        {% endif %}
        <td>{{ v.hgvsc }}</br>{{ v.hgvsp }}</td>
        <td>{{ v.gene }}</td>
        <td>{{ v.vaf }}%</td>
        <td>{{ v.gnomad }}</td>

        {% if v.checks|length > 0 %}
        <td>
        {% for check in v.checks %}
        {{ forloop.counter }}: {{ check.decision }} {{ check.user }}
        {% endfor %}
        </td>
        {% else %}
        <td>1: Pending</td>
        {% endif %}

        {% if v.status == 'Complete' %}
        <td>{{ v.status }}</td>
        {% else %}
        <td class=genuine-dropdown>
          <select name = "variant" id="variant">
            {% for option in check_options %}
            <option value="{{ option.0 }}">{{ option.1 }}</option>
            {% endfor %}
          </select>
        </td>
        {% endif %}

      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br>
  <h5>Tier 3</h5>
  <table class="table">
    <thead>
      <tr>
        <th class="col-md-4">Variant</th>
        <th class="col-md-4">HGVSc / HGVSp</th>
        <th class="col-md-1">Gene</th>
        <th class="col-md-1">VAF</th>
        <th class="col-md-2">GnomAD</th>
        <th class="col-md-4">Checks</th>
        <th class="col-md-2">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for v in germline_snvs_tier_three %}
      <tr>
        <td class="variant-id" style="display:none">{{ v.id }}</td>
        <td class="var-type" style="display:none">{{ v.var_type }}</td>
        {% if v.force_display %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</br><span class="badge badge-warning badge-pill">Possible MNV - Check IGV</span></td>
        {% else %}
          <td>{{ v.pk }}</br>{{ v.consequence }}</td>
        {% endif %}
        <td>{{ v.hgvsc }}</br>{{ v.hgvsp }}</td>
        <td>{{ v.gene }}</td>
        <td>{{ v.vaf }}%</td>
        <td>{{ v.gnomad }}</td>

        {% if v.checks|length > 0 %}
        <td>
        {% for check in v.checks %}
        {{ forloop.counter }}: {{ check.decision }} {{ check.user }}
        {% endfor %}
        </td>
        {% else %}
        <td>1: Pending</td>
        {% endif %}

        {% if v.status == 'Complete' %}
        <td>{{ v.status }}</td>
        {% else %}
        <td class=genuine-dropdown>
          <select name = "variant" id="variant">
            {% for option in check_options %}
            <option value="{{ option.0 }}">{{ option.1 }}</option>
            {% endfor %}
          </select>
        </td>
        {% endif %}
        
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br>
  <br>

  <div class="float-right">
    <button type="button" class="btn btn-success snv-submit" id = "snv-submit">Submit Checks</button>
  </div>
  <br>
  <br>

</div>

<script>
  // agax code to gather selections from dropdown
  $(".snv-submit").click(function(){
      var rows = $("table").children("tbody").children();
      var selection_dict = {};

      for (var i=0; i<rows.length; i++){
        // extract required variables
        var pk = $(rows[i]).children("td.variant-id").text();
        var type = $(rows[i]).children("td.var-type").text();
        var genuine_selection = $(rows[i]).children("td.genuine-dropdown").children().val();
        // compile into dictionary for individual variant
        var d = {};
        if (genuine_selection) {
          d['genuine_dropdown'] = genuine_selection;
        }
        // add to dictionary if it's not empty, allowing for a mixture of complete and incomplete variants
        if (Object.keys(d).length > 0){
          selection_dict[pk] = [type,d];
        }
      }

      // pass dict to JS form for AJAX POST
      var formData = new FormData();
      formData.append('csrfmiddlewaretoken',document.getElementsByName('csrfmiddlewaretoken')[0].value);
      formData.append('selections', JSON.stringify(selection_dict));
      formData.append('patient_analysis_pk', "{{ patient_analysis.pk }}");
      formData.append('variant_type', "snv");

      $.ajax({
          url: "{% url 'ajax' %}",
          type: 'POST',
          data: formData,
          contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
          processData: false, // NEEDED, DON'T OMIT THIS
          success: function(data) {
              if (data.redirect_url){
                window.location.href = data.redirect_url;
              }
          },
          failure: function(data) {
              alert('Got an error');
          }
      });
    })

<div class="container-fluid">

  <ul class="nav nav-tabs nav-justified">
  
    <!-- patient summary and QC information -->
    <li class="nav-item">
      <a class="nav-link section-button active" href="#details" data-target="details">Patient Details and QC</a>
    </li>
      
    <!-- Coverage -->
    <li class="nav-item">
      <a class="nav-link section-button" href="#coverage" data-target="coverage">Coverage</a>
    </li>

    <!-- SNVs -->
    <li class="nav-item">
      <a class="nav-link section-button" href="#snvs" data-target="snvs">SNVs & Indels</a>
    </li>

    <!-- CNVs -->
    <li class="nav-item">
      <a class="nav-link section-button" href="#cnvs" data-target="cnvs">CNVs</a>
    </li>

    <!-- Fusions -->
    <li class="nav-item">
      <a class="nav-link section-button" href="#fusions" data-target="fusions">Fusions</a>
    </li>

    <!-- MDT Notes -->
    <li class="nav-item">
      <a class="nav-link section-button" href="#mdt" data-target="mdt">MDT Notes</a>
    </li>

    <!-- Analysis and Checks -->
    <li class="nav-item">
      <a class="nav-link section-button" href="#checks" data-target="checks">Checks and Report</a>
    </li>
    </ul>
</div>

<!-- load in each section from template -->
<div class="container" id="details">{% include 'swgs/view_patient_analysis_details.html' %}</div>
<div class="container" id="coverage">{% include 'swgs/view_patient_analysis_coverage.html' %}</div>
<div class="container" id="snvs">{% include 'swgs/view_patient_analysis_snvs.html' %}</div>
<div class="container" id="cnvs">{% include 'swgs/view_patient_analysis_cnvs.html' %}</div>
<div class="container" id="fusions">{% include 'swgs/view_patient_analysis_fusions.html' %}</div>
<div class="container" id="mdt">{% include 'swgs/view_patient_analysis_mdt.html' %}</div>
<div class="container" id="checks">{% include 'swgs/view_patient_analysis_checks.html' %}</div>

<!--------------------------------------------------------------------------------------- 
    Javascript
---------------------------------------------------------------------------------------->
<script>

  // function to clear all sections
  function clear_sections(sections) {
      var i;
      for (i=0; i<sections.length; i++) {
          $(sections[i]).hide();
      };
  };


  // function to show specific section
  function show_section(target, sections) {
      // clear all sections content
      clear_sections(sections);
      // get button for section
      for (i=0; i<$('.section-button').length; i++) {
          var temp = '#' + $('.section-button')[i].dataset.target;
          if ( target == temp ) {
              var section_button = $('.section-button')[i];
          };
      };
      // clear active class from all, then add to current button
      $('.section-button').removeClass('active');
      $(section_button).addClass('active');
      // add section content
      $(target).fadeIn(200);
  };


  // get a list of section buttons
  var i; var sections_list = [];
  for (i=0; i<$('.section-button').length; i++) {
      sections_list.push('#' + $('.section-button')[i].dataset.target);
  };


  // page loadup - load section after hash otherwise load overview
  clear_sections(sections_list);
  if ( sections_list.includes(window.location.hash)) {
      show_section(window.location.hash, sections_list);
  } else {
      $("#details").fadeIn(200)
  };


  // handler for section button click
  $('.section-button').click(function() {
      var target = '#' + $(this).data('target');
      show_section(target, sections_list);
  });

  // allow tooltips
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })

</script>

{% endblock %}