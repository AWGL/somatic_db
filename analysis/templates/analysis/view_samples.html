{% extends 'analysis/base.html' %}
{% load crispy_forms_tags %}

{% block breadcrumbs %}
<nav class="breadcrumb flex-nowrap" aria-label="breadcrumb">
  <div class="container">
    <a class="breadcrumb-item active" href="{% url 'home' %}"><span class="fa fa-home"></span></a>
    <a class="breadcrumb-item active" href="{% url 'view_worksheets' 'recent' %}" aria-current="page">Worksheets</a>
    <a class="breadcrumb-item active" aria-current="page">{{ worksheet }}</a>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">
  <h5>Samples {{ worksheet }}</h5>
  <br>

  <table class="table" id="samples-table">
    <thead>
      <tr>
        <th scope="col">Sample ID</th>
        <th scope="col">Assay</th>
        <th scope="col">Panel</th>
        <th scope="col">Status</th>
        <th scope="col">Assigned to</th>
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      {% for sample, sample_info in samples.items %}
        {% for analysis in sample_info.panels %}
        <tr>
          <td>{{ sample }}</td>
          <td>{{ assay }}</td>
          <td>{{ analysis.panel }}</td>
          <td>{{ analysis.checks.current_status }}</td>
          <td>{{ analysis.checks.assigned_to }}</td>
          <td style="text-align:right">

            <!-- NOTE: order is important in the if loop below -->

            <!-- button when analysis is complete and the logged in user did the most recent check -->
            {% if analysis.checks.current_status == 'Complete' and request.user == analysis.checks.current_check_object.user %}
            <div class="btn-group btn-block">
              <a class="btn btn-info btn-block" href="{% url 'analysis_sheet' analysis.analysis_id %}#report" role="button">Complete</a>
              <button type="button btn-block" class="btn btn-info dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" data-toggle="modal" data-target="#reopen-modal" data-pk="{{ analysis.analysis_id }}" data-sample="{{ sample }}" data-panel="{{ analysis.panel }}" data-user="{{ analysis.checks.current_check_object.user }}">
                  Reopen Previous Check
                </a>
              </div>
            </div>
            
            <!-- button when analysis is complete -->
            {% elif analysis.checks.current_status == 'Complete' %}
            <a class="btn btn-light btn-block" href="{% url 'analysis_sheet' analysis.analysis_id %}#report" role="button">View</a>

            <!-- button when analysis is a fail and the logged in user did the most recent check -->
            {% elif analysis.checks.current_status == 'Fail' and request.user == analysis.checks.current_check_object.user %}
            <div class="btn-group btn-block">
              <a class="btn btn-danger btn-block" href="{% url 'analysis_sheet' analysis.analysis_id %}#report" role="button">Fail</a>
              <button type="button btn-block" class="btn btn-danger dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" data-toggle="modal" data-target="#reopen-modal" data-pk="{{ analysis.analysis_id }}" data-sample="{{ sample }}" data-panel="{{ analysis.panel }}" data-user="{{ analysis.checks.current_check_object.user }}">
                  Reopen Previous Check
                </a>
              </div>
            </div>

            <!-- button when analysis is a fail -->
            {% elif analysis.checks.current_status == 'Fail' %}
            <a class="btn btn-danger btn-block" href="{% url 'analysis_sheet' analysis.analysis_id %}#report" role="button">Fail</a>

            <!-- button when second check for fail required but unassigned -->
            {% elif analysis.checks.current_status == 'Fail - 2nd check required' and analysis.checks.assigned_to == None %}
            <a class="btn btn-warning btn-block" href="{% url 'analysis_sheet' analysis.analysis_id %}" role="button">Fail (check required)</a>

            <!-- button when second check for fail required and assigned to current user -->
            {% elif analysis.checks.current_status == 'Fail - 2nd check required' and analysis.checks.assigned_to == request.user %}
            <div class="btn-group btn-block">
              <a class="btn btn-warning btn-block btn-disabled" href="{% url 'analysis_sheet' analysis.analysis_id %}" role="button">Fail - analyse 2nd check</a>
              <button type="button btn-block" class="btn btn-warning dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" data-toggle="modal" data-target="#unassign-modal" data-pk="{{ analysis.analysis_id }}" data-sample="{{ sample }}" data-panel="{{ analysis.panel }}" data-user="{{ analysis.checks.assigned_to }}" data-status="{{ analysis.checks.current_status }}">
                  Unassign
                </a>
              </div>
            </div>

            <!-- button when second check for fail required and assigned to someone else -->
            {% elif analysis.checks.current_status == 'Fail - 2nd check required' and analysis.checks.assigned_to != request.user %}
            <div class="btn-group btn-block">
              <a class="btn btn-warning btn-block btn-disabled" href="#" role="button">Fail - assigned to {{ analysis.checks.assigned_to }}</a>
              <button type="button btn-block" class="btn btn-warning dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" data-toggle="modal" data-target="#unassign-modal" data-pk="{{ analysis.analysis_id }}" data-sample="{{ sample }}" data-panel="{{ analysis.panel }}" data-user="{{ analysis.checks.assigned_to }}" data-status="{{ analysis.checks.current_status }}">
                  Unassign
                </a>
              </div>
            </div>

            <!-- button when no one is assigned to an analysis 1st check (goes to check modal for 1st check only)-->
            {% elif analysis.checks.assigned_to == None and analysis.checks.current_status == 'IGV check 1' %}
            <a class="btn btn-secondary btn-block" href="#" data-toggle="modal" data-target="#check-modal" data-pk="{{ analysis.analysis_id }}" data-sample="{{ sample }}" data-panel="{{ analysis.panel }}" data-ws="{{ worksheet }}" data-run="{{ run_id }}">
              Assign to me & analyse
            </a>

            <!-- button when no one is assigned to an analysis after 1st check -->
            {% elif analysis.checks.assigned_to == None and analysis.checks.current_status != 'IGV check 1' %}
            <a class="btn btn-secondary btn-block" href="{% url 'analysis_sheet' analysis.analysis_id %}" role="button">Assign to me & analyse</a>

            <!-- button if analysis is assigned to someone else -->
            {% elif analysis.checks.assigned_to != request.user %}
            <div class="btn-group btn-block">
              <a class="btn btn-light btn-block btn-disabled" href="#" role="button">Assigned to {{ analysis.checks.assigned_to }}</a>
              <button type="button btn-block" class="btn btn-light dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" data-toggle="modal" data-target="#unassign-modal" data-pk="{{ analysis.analysis_id }}" data-sample="{{ sample }}" data-panel="{{ analysis.panel }}" data-user="{{ analysis.checks.assigned_to }}" data-status="{{ analysis.checks.current_status }}">
                  Unassign
                </a>
              </div>
            </div>

            <!-- button if analysis is assigned to current user -->
            {% elif analysis.checks.assigned_to == request.user %}
            <div class="btn-group btn-block">
              <a class="btn btn-success btn-block" href="{% url 'analysis_sheet' analysis.analysis_id %}" role="button">
                Analyse
              </a>
              <button type="button btn-block" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" data-toggle="modal" data-target="#unassign-modal" data-pk="{{ analysis.analysis_id }}" data-sample="{{ sample }}" data-panel="{{ analysis.panel }}" data-user="{{ analysis.checks.assigned_to }}" data-status="{{ analysis.checks.current_status }}">
                  Unassign
                </a>
              </div>
            </div>

            {% endif %}

          </td>
        </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>
  <br>
  <br>

</div>


<!-- Unassign modal -->
<div class="modal fade" id="unassign-modal" tabindex="-1" role="dialog" aria-labelledby="unassign-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="unassign-modal-label">Unassign analysis</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <strong>Warning!</strong> Are you sure you want to continue?<br>
          Unassigning a user will reset any decisions and comments from the current check 
        </div>

        <table class="table table-sm table-striped table-hover">
          <tbody>
            <tr>
              <th>Sample</td>
              <td class="modal-sample"></td>
            </tr>
            <tr>
              <th>Panel</td>
              <td class="modal-panel"></td>
            </tr>
            <tr>
              <th>Current check</td>
              <td class="modal-status"></td>
            </tr>
            <tr>
              <th>Assigned to</td>
              <td class="modal-assigned"></td>
            </tr>
          </tbody>
        </table>

        {% crispy unassign_form %}

      </div>
    </div>
  </div>
</div>

<!-- Reopen modal -->
<div class="modal fade" id="reopen-modal" tabindex="-1" role="dialog" aria-labelledby="reopen-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reopen-modal-label">Reopen Most Recent Check</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <strong>Warning!</strong> Are you sure you want to continue?<br>
          This sample will be reopened at its previous check. 
        </div>

        <table class="table table-sm table-striped table-hover">
          <tbody>
            <tr>
              <th>Sample</td>
              <td class="modal-sample"></td>
            </tr>
            <tr>
              <th>Panel</td>
              <td class="modal-panel"></td>
            </tr>
            <tr>
              <th>Assigned to</td>
              <td class="modal-assigned"></td>
            </tr>
          </tbody>
        </table>

        {% crispy reopen_form %}

      </div>
    </div>
  </div>
</div>

<!-- Check modal -->
<div class="modal fade" id="check-modal" tabindex="-1" role="dialog" aria-labelledby="check-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="check-modal-label">Paperwork check</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <strong>Please check the patient details against the referral paperwork</strong>
        </div>

        <table class="table table-sm table-striped table-hover">
          <tbody>
            <tr>
              <th>Sample</td>
              <td class="modal-sample"></td>
            </tr>
            <tr>
              <th>Panel</td>
              <td class="modal-panel"></td>
            </tr>
          </tbody>
        </table>

        {% crispy check_form %}


        <button class="btn btn-light w-100" type="button" data-toggle="collapse" data-target="#wrong-referral" aria-expanded="false" aria-controls="wrong-referral">
          Incorrect referral? Click here
        </button>
        <div class="collapse" id="wrong-referral">

          <p>
            If there is a mistake, bioinformatics will need to remove the incorrect panel and upload the corrected one.<br>
            Please send the correct panel and the following information to <b>bioinformatics@wales.nhs.uk</b>:
          </p>
          <div class="card-body bg-light">
            <table class="table table-sm">
              <tbody>
                <tr>
                  <td>ISSUE CODE #1</td>
                  <td></td>
                </tr>
                <tr>
                  <td>SampleAnalysis PK: </td>
                  <td class="modal-pk"></td>
                </tr>
                <tr>
                  <td>Sample ID: </td>
                  <td class="modal-sample"></td>
                </tr>
                <tr>
                  <td>Current panel (the incorrect one): </td>
                  <td class="modal-panel"></td>
                </tr>
                <tr>
                  <td>Worksheet ID: </td>
                  <td class="modal-ws"></td>
                </tr>
                <tr>
                  <td>Run ID: </td>
                  <td class="modal-run"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <p>Please note, by default <b>we will remove the incorrect version of the panel</b>, please let us know if you do not want this to happen.</p>
        </div>
      </div>
    </div>
  </div>
</div>



<script>
    $(document).ready( function() {

        // remove anthing after the hash in the URL, to prevent carrying over from a previous analysis (see issue #47)
        var uri = window.location.toString();
        if (uri.indexOf("#") > 0) {
            var clean_uri = uri.substring(0, uri.indexOf("#"));
            window.history.replaceState({}, document.title, clean_uri);
        }

        // Inititialise DataTable
        $('#samples-table').DataTable({
            paging: true,
            columns: [
                {orderable: true},
                {orderable: true},
                {orderable: true},
                {orderable: true},
                {orderable: true},
                {orderable: false},
            ],
            info: true,
            pageLength: 25,
            searching: true,
            aaSorting: [],
            language: {
                searchPlaceholder: "Search by sample ID, panel, status or user",
                search: "",
            },
            initComplete: function () {
                $('.dataTables_filter input[type="search"]').css({ 'width': '500px', 'display': 'inline-block' });
            },
        });
    } );

    // pull analysis PK into the unnassign modal
    $('#unassign-modal').on('show.bs.modal', function (event) {
        // extract variables from button tags
        var button = $(event.relatedTarget);
        var pk = button.data('pk');
        var sample = button.data('sample');
        var panel = button.data('panel');
        var status = button.data('status');
        var assigned = button.data('user');
        var modal = $(this);

        // fill out table of sample details
        modal.find('.modal-sample').text(sample);
        modal.find('.modal-panel').text(panel);
        modal.find('.modal-status').text(status);
        modal.find('.modal-assigned').text(assigned);

        // put sample PK into hidden form so that it can be passed to backend
        document.getElementById ('id_unassign').value = pk;
    })

    // pull analysis PK into the reopen modal
    $('#reopen-modal').on('show.bs.modal', function (event) {
        // extract variables from button tags
        var button = $(event.relatedTarget);
        var pk = button.data('pk');
        var sample = button.data('sample');
        var panel = button.data('panel');
        var assigned = button.data('user');
        var modal = $(this);

        // fill out table of sample details
        modal.find('.modal-sample').text(sample);
        modal.find('.modal-panel').text(panel);
        modal.find('.modal-assigned').text(assigned);

        // put sample PK into hidden form so that it can be passed to backend
        document.getElementById ('id_reopen').value = pk;
    })

    // pull analysis PK into the check modal
    $('#check-modal').on('show.bs.modal', function (event) {
        // extract variables from button tags
        var button = $(event.relatedTarget);
        var pk = button.data('pk');
        var sample = button.data('sample');
        var panel = button.data('panel');
        var ws = button.data('ws');
        var run = button.data('run');
        var modal = $(this);

        // fill out table of sample details
        modal.find('.modal-pk').text(pk);
        modal.find('.modal-sample').text(sample);
        modal.find('.modal-panel').text(panel);
        modal.find('.modal-ws').text(ws);
        modal.find('.modal-run').text(run);

        // put sample PK into hidden form so that it can be passed to backend
        document.getElementById ('id_sample').value = pk;
    })
</script>

{% endblock %}