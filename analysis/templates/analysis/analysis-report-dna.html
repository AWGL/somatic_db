{% load crispy_forms_tags %}

{% if sample_data.checks.current_status  == 'Fail' %}
<div class="alert alert-danger">
  <div class="container">
    <div class="row">
      <div class="col-8">
        <strong>Warning!</strong> This sample has failed.
      </div>
      <div class="col-4">
        <form method="GET">
          <button type="submit" name="download-dna" id="download" class="btn btn-danger w-100">Download report</button>
        </form>
      </div>
    </div>
  </div>  
</div>

{% else %}
<div class="alert alert-success">
  <div class="container">
    <div class="row">
      <div class="col-8">
        <strong>Success!</strong> This sample has completed analysis.
      </div>
      <div class="col-4">
        <form method="GET">
          <button type="submit" name="download-dna" id="download" class="btn btn-success w-100">Download report</button>
        </form>
      </div>
    </div>
  </div>  
</div>

{% endif %}
<br>

<h5>Variants</h5>
<table class="table table-sm table-striped table-hover">
  <thead>
    <tr>
      <th scope="col">Variant</th>
      <th scope="col">Gene</th>
      <th scope="col">HGVSc</th>
      <th scope="col">HGVSp</th>
      <th scope="col">VAF</th>
      <th scope="col">IGV</th>
      <th scope="col">Comments</th>
    </tr>
  </thead>

  <tbody>
    {% for v in variant_data.variant_calls %}

    {% if v.final_decision == "Genuine" or v.final_decision == "Miscalled" %}
    <tr>
      <td class="variant-pk" style="display:none">{{ v.pk }}</td>
      <td><p style="display:inline" id="igv">{{ v.genomic }} </p></td>
      <td>{{ v.gene }} ({{ v.exon }})</td>
      <td>{{ v.hgvs_c }}</td>
      <td>{{ v.hgvs_p }}</td>
      <td>{{ v.vaf.vaf }}%</td>
      <td>{{ v.final_decision }}</td>
      <td>
      {% for c in v.comments %}
        {{ c.user }}-{{ c.comment }}<br>
      {% endfor %}
      </td>
    </tr>
    {% endif %}

    {% endfor %}
  </tbody>
</table>
<br>

<div class="container-fluid">
  <div class="row">
    <div class="col-sm">

      <h5>Coverage</h5>
      <table class="table table-sm table-striped table-hover">
        <thead>
          <tr>
            <th scope="col">Gene</th>
            <th scope="col">Percent 135X</th>
            <th scope="col">Percent 270X</th>
          </tr>
        </thead>

        <tbody>
          {% for gene, values in coverage_data.items %}
          <tr>
            <td>{{ gene }}</td>
            <td>{{ values.percent_135x }}</td>
            <td>{{ values.percent_270x }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
    <div class="col-sm">

      <h5>Hotspot gaps 270X</h5>
      <table class="table table-sm table-striped table-hover">
        <thead>
          <tr>
            <th scope="col">Gap</th>
            <th scope="col">Percent COSMIC</th>
          </tr>
        </thead>

        <tbody>
          {% for gene, values in coverage_data.items %}
            {% for gap in values.gaps_270 %}
            <tr>
              <td>{{ gene }} {{ gap.hgvs_c }}</td>
              <td>{{ gap.cosmic }}</td>
            </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>

    </div>
    <div class="col-sm">

      <h5>Hotspot gaps 135X</h5>
      <table class="table table-sm table-striped table-hover">
        <thead>
          <tr>
            <th scope="col">Gap</th>
            <th scope="col">Percent COSMIC</th>
          </tr>
        </thead>

        <tbody>
          {% for gene, values in coverage_data.items %}
            {% for gap in values.gaps_135 %}
            <tr>
              <td>{{ gene }} {{ gap.hgvs_c }}</td>
              <td>{{ gap.cosmic }}</td>
            </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>

    </div>
  </div>
</div> 
<br>

<h5>Checks performed</h5>
<table class="table table-sm table-bordered">
  <thead>
    <tr>
      <th>Check</th>
      <th>User</th>
      <th>Patient info check</th>
      <th>NTC check</th>
      <th>Comments</th>
      
    </tr>
  </thead>
  <tbody>
    {% for c in sample_data.checks.all_checks %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ c.user }}<br>{{ c.signoff_time }}</td>
      <td>{{ c.patient_info_check }}</td>
      <td>{{ c.coverage_ntc_check }}</td>
      <td>
        <b>Coverage:</b> {{ c.coverage_comment | wordwrap:100 | linebreaksbr }}<br>
        <b>Overall:</b> {{ c.overall_comment | wordwrap:100 | linebreaksbr }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<br>
